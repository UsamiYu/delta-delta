/*
 * bulletml.js v0.5.0
 * https://github.com/daishihmr/bulletml.js
 * 
 * The MIT License (MIT)
 * Copyright © 2014 daishi_hmr, dev7.jp
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
 * associated documentation files (the “Software”), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 * 
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */


var bulletml={};bulletml.GLOBAL=this,function(){function a(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c].label==b)return a[c]}bulletml.Node=function(){},bulletml.Node.prototype.scan=function(a){a(this);for(var b in this)if(this.hasOwnProperty(b)){var c=this[b];c instanceof bulletml.Node&&c.scan(a)}},bulletml.Root=function(a){if(bulletml.Node.call(this),this.type="none",this.root=this,this.actions=[],this.bullets=[],this.fires=[],void 0!==a){for(var b in a)a.hasOwnProperty(b)&&(a[b].label=b,a[b]instanceof bulletml.Action?this.actions.push(a[b]):a[b]instanceof bulletml.Bullet?this.bullets.push(a[b]):a[b]instanceof bulletml.Fire&&this.fires.push(a[b]));for(var c=0,d=this.actions.length;d>c;c++)this.actions[c].setRoot(this);for(var c=0,d=this.bullets.length;d>c;c++)this.bullets[c].setRoot(this);for(var c=0,d=this.fires.length;d>c;c++)this.fires[c].setRoot(this)}},bulletml.Root.prototype=Object.create(bulletml.Node.prototype),bulletml.Root.prototype.findAction=function(b){return a(this.actions,b)},bulletml.Root.prototype.getTopActionLabels=function(){for(var a=[],b=0,c=this.actions.length;c>b;b++){var d=this.actions[b];d.label&&0===d.label.indexOf("top")&&(a[a.length]=d.label)}return a},bulletml.Root.prototype.findActionOrThrow=function(a){var b;if(b=this.findAction(a))return b;throw new Error("action labeled '"+a+"' is undefined.")},bulletml.Root.prototype.findBullet=function(b){return a(this.bullets,b)},bulletml.Root.prototype.findBulletOrThrow=function(a){var b;if(b=this.findBullet(a))return b;throw new Error("bullet labeled '"+a+"' is undefined.")},bulletml.Root.prototype.findFire=function(b){return a(this.fires,b)},bulletml.Root.prototype.findFireOrThrow=function(a){var b;if(b=this.findFire(a))return b;throw new Error("fire labeled '"+a+"' is undefined.")},bulletml.Bullet=function(){bulletml.Node.call(this),this.label=null,this.root=null,this.direction=new bulletml.Direction(0),this.speed=new bulletml.Speed(1),this.actions=[],this.option={},this._localScope={}},bulletml.Bullet.prototype=Object.create(bulletml.Node.prototype),bulletml.Bullet.prototype.clone=function(a){var b=new bulletml.Bullet;return b.label=this.label,b.root=this.root,b.actions=this.actions,b.direction=new bulletml.Direction(a._evalParam(this.direction.value)),b.direction.type=this.direction.type,b.speed=new bulletml.Speed(a._evalParam(this.speed.value)),b.speed.type=this.speed.type,b.option=this.option,b._localScope=a._localScope,b},bulletml.Bullet.prototype.setRoot=function(a){this.root=a;for(var b=0,c=this.actions.length;c>b;b++)this.actions[b].setRoot(a)},bulletml.BulletRef=function(a){bulletml.Node.call(this),this.root=null,this.label=a,this.params=[]},bulletml.BulletRef.prototype=Object.create(bulletml.Node.prototype),bulletml.BulletRef.prototype.clone=function(a){var b=a._localScope;a._localScope=a._newScope(this.params);var c=this.root.findBulletOrThrow(this.label).clone(a);return a._localScope=b,c},bulletml.BulletRef.prototype.setRoot=function(a){this.root=a},bulletml.Command=function(){bulletml.Node.call(this),this.commandName=""},bulletml.Command.prototype=Object.create(bulletml.Node.prototype),bulletml.Command.prototype.setRoot=function(a){this.root=a},bulletml.Action=function(){bulletml.Command.call(this),this.commandName="action",this.label=null,this.root=null,this.commands=[],this.params=[]},bulletml.Action.prototype=Object.create(bulletml.Command.prototype),bulletml.Action.prototype.setRoot=function(a){this.root=a;for(var b=0,c=this.commands.length;c>b;b++)this.commands[b].setRoot(a)},bulletml.Action.prototype.clone=function(){var a=new bulletml.Action;return a.label=this.label,a.root=this.root,a.commands=this.commands,a},bulletml.ActionRef=function(a){bulletml.Command.call(this),this.commandName="actionRef",this.label=a,this.root=null,this.params=[]},bulletml.ActionRef.prototype=Object.create(bulletml.Command.prototype),bulletml.ActionRef.prototype.clone=function(){var a=new bulletml.Action;return a.root=this.root,a.commands.push(this),a},bulletml.Fire=function(){bulletml.Command.call(this),this.commandName="fire",this.label=null,this.root=null,this.direction=null,this.speed=null,this.bullet=null,this.option=new bulletml.FireOption},bulletml.Fire.prototype=Object.create(bulletml.Command.prototype),bulletml.Fire.prototype.setRoot=function(a){this.root=a,this.bullet&&this.bullet.setRoot(a)},bulletml.FireRef=function(a){bulletml.Command.call(this),this.commandName="fireRef",this.label=a,this.params=[]},bulletml.FireRef.prototype=Object.create(bulletml.Command.prototype),bulletml.ChangeDirection=function(){bulletml.Command.call(this),this.commandName="changeDirection",this.direction=new bulletml.Direction,this.term=0},bulletml.ChangeDirection.prototype=Object.create(bulletml.Command.prototype),bulletml.ChangeSpeed=function(){bulletml.Command.call(this),this.commandName="changeSpeed",this.speed=new bulletml.Speed,this.term=0},bulletml.ChangeSpeed.prototype=Object.create(bulletml.Command.prototype),bulletml.Accel=function(){bulletml.Command.call(this),this.commandName="accel",this.horizontal=new bulletml.Horizontal,this.vertical=new bulletml.Vertical,this.term=0},bulletml.Accel.prototype=Object.create(bulletml.Command.prototype),bulletml.Wait=function(a){bulletml.Command.call(this),this.commandName="wait",this.value=a||0},bulletml.Wait.prototype=Object.create(bulletml.Command.prototype),bulletml.Vanish=function(){bulletml.Command.call(this),this.commandName="vanish"},bulletml.Vanish.prototype=Object.create(bulletml.Command.prototype),bulletml.Repeat=function(){bulletml.Command.call(this),this.commandName="repeat",this.times=0,this.action=null,this.params=[]},bulletml.Repeat.prototype=Object.create(bulletml.Command.prototype),bulletml.Repeat.prototype.setRoot=function(a){this.root=a,this.action&&this.action.setRoot(a)},bulletml.Bind=function(a,b){bulletml.Command.call(this),this.commandName="bind",this.variable=a,this.expression=b},bulletml.Bind.prototype=Object.create(bulletml.Command.prototype),bulletml.Notify=function(a,b){bulletml.Command.call(this),this.commandName="notify",this.eventName=a,this.params=b||null},bulletml.Notify.prototype=Object.create(bulletml.Command.prototype),bulletml.DummyCommand=new bulletml.Command,bulletml.Direction=function(a){bulletml.Node.call(this),this.type="aim",this.value=a||0},bulletml.Direction.prototype=Object.create(bulletml.Node.prototype),bulletml.Speed=function(a){bulletml.Node.call(this),this.type="absolute",this.value=void 0===a?1:a},bulletml.Speed.prototype=Object.create(bulletml.Node.prototype),bulletml.Horizontal=function(a){bulletml.Node.call(this),this.type="absolute",this.value=a||0},bulletml.Horizontal.prototype=Object.create(bulletml.Node.prototype),bulletml.Vertical=function(a){bulletml.Node.call(this),this.type="absolute",this.value=a||0},bulletml.Vertical.prototype=Object.create(bulletml.Node.prototype),bulletml.FireOption=function(a){bulletml.Node.call(this),a=a||{},this.offsetX=a.offsetX||0,this.offsetY=a.offsetY||0,this.autonomy=!0,void 0!==a.autonomy&&(this.autonomy=!!a.autonomy)},bulletml.FireOption.prototype=Object.create(bulletml.Node.prototype),bulletml.OffsetX=function(a){bulletml.Node.call(this),this.value=a||0},bulletml.OffsetX.prototype=Object.create(bulletml.Node.prototype),bulletml.OffsetY=function(a){bulletml.Node.call(this),this.value=a||0},bulletml.OffsetY.prototype=Object.create(bulletml.Node.prototype),bulletml.Autonomy=function(a){bulletml.Node.call(this),this.value=!!a},bulletml.Autonomy.prototype=Object.create(bulletml.Node.prototype)}(),function(){bulletml.Walker=function(a){this._root=a,this._stack=[],this._cursor=-1,this._action=null,this._localScope={}},bulletml.Walker.prototype.next=function(){if(this._cursor+=1,null!==this._action){var a=this._action.commands[this._cursor];if(void 0!==a){if(a instanceof bulletml.Action)return this._pushStack(),this._action=a,this._localScope=this._cloneScope(),this.next();if(a instanceof bulletml.ActionRef)return this._pushStack(),this._action=this._root.findActionOrThrow(a.label),this._localScope=this._newScope(a.params),this.next();if(a instanceof bulletml.Repeat)return this._localScope.loopCounter=0,this._localScope.loopEnd=0|this._evalParam(a.times),this._pushStack(),this._action=a.action.clone(),this._localScope=this._cloneScope(),this.next();if(a instanceof bulletml.Fire){var b=new bulletml.Fire;return b.bullet=a.bullet.clone(this),null!==a.direction&&(b.direction=new bulletml.Direction(this._evalParam(a.direction.value)),b.direction.type=a.direction.type),null!==a.speed&&(b.speed=new bulletml.Speed(this._evalParam(a.speed.value)),b.speed.type=a.speed.type),b.option=new bulletml.FireOption,b.option.offsetX=this._evalParam(a.option.offsetX),b.option.offsetY=this._evalParam(a.option.offsetY),b.option.autonomy=a.option.autonomy,b}if(a instanceof bulletml.FireRef)return this._pushStack(),this._action=new bulletml.Action,this._action.commands=[this._root.findFireOrThrow(a.label)],this._localScope=this._newScope(a.params),this.next();if(a instanceof bulletml.ChangeDirection){var c=new bulletml.ChangeDirection;return c.direction.type=a.direction.type,c.direction.value=this._evalParam(a.direction.value),c.term=this._evalParam(a.term),c}if(a instanceof bulletml.ChangeSpeed){var d=new bulletml.ChangeSpeed;return d.speed.type=a.speed.type,d.speed.value=this._evalParam(a.speed.value),d.term=this._evalParam(a.term),d}if(a instanceof bulletml.Accel){var e=new bulletml.Accel;return e.horizontal.type=a.horizontal.type,e.horizontal.value=this._evalParam(a.horizontal.value),e.vertical.type=a.vertical.type,e.vertical.value=this._evalParam(a.vertical.value),e.term=this._evalParam(a.term),e}return a instanceof bulletml.Wait?new bulletml.Wait(this._evalParam(a.value)):a instanceof bulletml.Vanish?a:a instanceof bulletml.Bind?(this._localScope["$"+a.variable]=this._evalParam(a.expression),bulletml.DummyCommand):a instanceof bulletml.Notify?a:null}return this._popStack(),null===this._action?null:(a=this._action.commands[this._cursor],a&&"repeat"==a.commandName?(this._localScope.loopCounter++,this._localScope.loopCounter<this._localScope.loopEnd?(this._pushStack(),this._action=a.action.clone(),this._localScope=this._cloneScope(),this.next()):this.next()):this.next())}return null},bulletml.Walker.prototype._pushStack=function(){this._stack.push({action:this._action,cursor:this._cursor,scope:this._localScope}),this._cursor=-1},bulletml.Walker.prototype._popStack=function(){var a=this._stack.pop();a?(this._cursor=a.cursor,this._action=a.action,this._localScope=a.scope):(this._cursor=-1,this._action=null,this._localScope={})},bulletml.Walker.prototype._evalParam=function(a){var b;if("boolean"==typeof a)return a?1:0;if("number"==typeof a)return a;if(!isNaN(b=Number(a)))return b;if(b=this._localScope[a])return b;if(b=bulletml.Walker.globalScope[a])return b;if("$rand"===a)return Math.random();var c={};for(var d in bulletml.Walker.globalScope)bulletml.Walker.globalScope.hasOwnProperty(d)&&(c[d]=bulletml.Walker.globalScope[d]);for(var d in this._localScope)this._localScope.hasOwnProperty(d)&&(c[d]=this._localScope[d]);c.$rand=Math.random();var e=this._stack[this._stack.length-1];e&&(c.$loop={index:e.scope.loopCounter,count:e.scope.loopCounter+1,first:0===e.scope.loopCounter,last:e.scope.loopCounter+1>=e.scope.loopEnd});var f=new Function("return "+a.split("$").join("this.$")),g=f.apply(c);return g},bulletml.Walker.prototype._newScope=function(a){var b={};if(a)for(var c=0,d=a.length;d>c;c++)b["$"+(c+1)]=this._evalParam(a[c]);else for(var e in this._localScope)this._localScope.hasOwnProperty(e)&&(b[e]=this._localScope[e]);return b},bulletml.Walker.prototype._cloneScope=function(){var a={};for(var b in this._localScope)this._localScope.hasOwnProperty(b)&&(a[b]=this._localScope[b]);return a},bulletml.Root.prototype.getWalker=function(a){var b=new bulletml.Walker(this),c=this.findAction(a);return c&&(b._action=c),b},bulletml.Bullet.prototype.getWalker=function(){var a=new bulletml.Walker(this.root),b=new bulletml.Action;return b.root=this.root,b.commands=this.actions,a._action=b,a._localScope=this._localScope,a},bulletml.Walker.globalScope={}}(),function(){function a(a){var c=new bulletml.Root,e=a.getElementsByTagName("bulletml")[0];if(e){u(e,"type",function(a){c.type=a});var g=e.getElementsByTagName("action");if(g)for(var h=0,i=g.length;i>h;h++)if(g[h].parentNode===e){var j=b(c,g[h]);j&&(c.actions[c.actions.length]=j)}var k=e.getElementsByTagName("bullet");if(k)for(var h=0,i=k.length;i>h;h++)if(k[h].parentNode===e){var l=d(c,k[h]);l&&(c.bullets[c.bullets.length]=l)}var m=e.getElementsByTagName("fire");if(m)for(var h=0,i=m.length;i>h;h++)if(m[h].parentNode===e){var n=f(c,m[h]);n&&(c.fires[c.fires.length]=n)}return c}}function b(a,d){var e=new bulletml.Action;return u(d,"label",function(a){e.label=a}),t(d,".",function(d){switch(d.tagName.toLowerCase()){case"action":e.commands[e.commands.length]=b(a,d);break;case"actionref":e.commands[e.commands.length]=c(a,d);break;case"fire":e.commands[e.commands.length]=f(a,d);break;case"fireref":e.commands[e.commands.length]=g(a,d);break;case"changedirection":e.commands[e.commands.length]=h(a,d);break;case"changespeed":e.commands[e.commands.length]=i(a,d);break;case"accel":e.commands[e.commands.length]=j(a,d);break;case"wait":e.commands[e.commands.length]=k(a,d);break;case"vanish":e.commands[e.commands.length]=l(a,d);break;case"repeat":e.commands[e.commands.length]=m(a,d)}}),e.root=a,e}function c(a,b){var c=new bulletml.ActionRef(u(b,"label"));return t(b,/param$/,function(a){c.params[c.params.length]=v(a)}),c.root=a,c}function d(a,d){var e=new bulletml.Bullet;return u(d,"label",function(a){e.label=a}),s(d,"direction",function(a){e.direction=n(a)}),s(d,"speed",function(a){e.speed=o(a)}),t(d,/(action)|(actionRef)$/,function(d){"action"==d.tagName.toLowerCase()?e.actions[e.actions.length]=b(a,d):"actionref"==d.tagName.toLowerCase()&&(e.actions[e.actions.length]=c(a,d))}),e.root=a,e}function e(a,b){var c=new bulletml.BulletRef(u(b,"label"));return t(b,/param$/,function(a){c.params[c.params.length]=v(a)}),c.root=a,c}function f(a,b){var c=new bulletml.Fire;if(u(b,"label",function(a){c.label=a}),s(b,"direction",function(a){c.direction=n(a)}),s(b,"speed",function(a){c.speed=o(a)}),s(b,"bullet",function(b){c.bullet=d(a,b)}),s(b,"bulletref",function(b){c.bullet=e(a,b)}),!c.bullet)throw new Error("fire has no bullet or bulletRef.");return c.root=a,c}function g(a,b){var c=new bulletml.FireRef(u(b,"label"));return t(b,/param$/,function(a){c.params[c.params.length]=v(a)}),c.root=a,c}function h(a,b){var c=new bulletml.ChangeDirection;return c.root=a,s(b,"direction",function(a){c.direction=n(a)}),s(b,"term",function(a){c.term=v(a)}),c}function i(a,b){var c=new bulletml.ChangeSpeed;return c.root=a,s(b,"speed",function(a){c.speed=o(a)}),s(b,"term",function(a){c.term=v(a)}),c}function j(a,b){var c=new bulletml.Accel;return c.root=a,s(b,"horizontal",function(a){c.horizontal=p(a)}),s(b,"vertical",function(a){c.vertical=q(a)}),s(b,"term",function(a){c.term=v(a)}),c}function k(a,b){var c=new bulletml.Wait;return c.root=a,c.value=v(b),c}function l(a){var b=new bulletml.Vanish;return b.root=a,b}function m(a,d){var e=new bulletml.Repeat;return s(d,"action",function(c){e.action=b(a,c)}),s(d,"actionRef",function(b){e.action=c(a,b)}),s(d,"times",function(a){e.times=v(a)}),e.root=a,e}function n(a){return r(new bulletml.Direction,a)}function o(a){return r(new bulletml.Speed,a)}function p(a){return r(new bulletml.Horizontal,a)}function q(a){return r(new bulletml.Vertical,a)}function r(a,b){return u(b,"type",function(b){a.type=b}),v(b,function(b){a.value=b}),a}function s(a,b,c,d){b=b.toLowerCase();for(var e=a.childNodes,f=0,g=e.length;g>f;f++)if(e[f].tagName&&e[f].tagName.toLowerCase()==b)return c&&c(e[f]),e[f];return d&&d(),null}function t(a,b,c){for(var d=a.childNodes,e=0,f=d.length;f>e;e++)d[e].tagName&&d[e].tagName.toLowerCase().match(b)&&c(d[e])}function u(a,b,c,d){var e=a.attributes,f=e[b];return f?(c&&c(f.value),f.value):(d&&d(),"")}function v(a,b){var c=a.textContent.trim();return void 0!==c?(b&&b(c),c):""}bulletml.buildXML=function(b){var c;if("string"==typeof b){var d=new DOMParser;c=a(d.parseFromString(b,"application/xml"))}else{if(!b.getElementsByTagName("bulletml"))throw new Error("cannot build "+b);c=a(b)}return c}}(),function(){bulletml.dsl=function(a){a=a||"";for(var b in bulletml.dsl)bulletml.dsl.hasOwnProperty(b)&&(bulletml.GLOBAL[a+b]=bulletml.dsl[b])},bulletml.dsl.action=function(a){if(arguments.length>0)for(var b=0,c=arguments.length;c>b;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(a instanceof Array)for(var b=0,c=a.length;c>b;b++)a[b]instanceof Function&&(a[b]=a[b]());var d=new bulletml.Action;if(a instanceof Array){if(a.some(function(a){return!(a instanceof bulletml.Command)}))throw new Error("argument type error.");d.commands=a}else for(var b=0,c=arguments.length;c>b;b++){if(!(arguments[b]instanceof bulletml.Command))throw new Error("argument type error.");d.commands[b]=arguments[b]}return d},bulletml.dsl.actionRef=function(a,b){for(var c=0,d=arguments.length;d>c;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0===a)throw new Error("label is required.");var e=new bulletml.ActionRef(a);if(b instanceof Array)e.params=b;else for(var c=1;c<arguments.length;c++)e.params.push(arguments[c]);return e},bulletml.dsl.bullet=function(){for(var a=0,b=arguments.length;b>a;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());for(var c=new bulletml.Bullet,a=0;a<arguments.length;a++)arguments[a]instanceof bulletml.Direction?c.direction=arguments[a]:arguments[a]instanceof bulletml.Speed?c.speed=arguments[a]:arguments[a]instanceof bulletml.Action?c.actions.push(arguments[a]):arguments[a]instanceof bulletml.ActionRef?c.actions.push(arguments[a]):arguments[a]instanceof Array?c.actions.push(bulletml.dsl.action(arguments[a])):arguments[a]instanceof Object?c.option=arguments[a]:"string"==typeof arguments[a]&&(c.label=arguments[a]);return c},bulletml.dsl.bulletRef=function(a,b){for(var c=0,d=arguments.length;d>c;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0===a)throw new Error("label is required.");var e=new bulletml.BulletRef(a);if(b instanceof Array)e.params=b;else for(var c=1;c<arguments.length;c++)e.params.push(arguments[c]);return e},bulletml.dsl.fire=function(){for(var a=0,b=arguments.length;b>a;a++)arguments[a]instanceof Function&&(arguments[a]=arguments[a]());for(var c=new bulletml.Fire,a=0;a<arguments.length;a++)arguments[a]instanceof bulletml.Direction?c.direction=arguments[a]:arguments[a]instanceof bulletml.Speed?c.speed=arguments[a]:arguments[a]instanceof bulletml.Bullet?c.bullet=arguments[a]:arguments[a]instanceof bulletml.BulletRef?c.bullet=arguments[a]:arguments[a]instanceof bulletml.FireOption?c.option=arguments[a]:arguments[a]instanceof bulletml.OffsetX?c.option.offsetX=arguments[a].value:arguments[a]instanceof bulletml.OffsetY?c.option.offsetY=arguments[a].value:arguments[a]instanceof bulletml.Autonomy&&(c.option.autonomy=arguments[a].value);if(void 0===c.bullet)throw new Error("bullet (or bulletRef) is required.");return c},bulletml.dsl.fireRef=function(a,b){for(var c=0,d=arguments.length;d>c;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0===a)throw new Error("label is required.");var e=new bulletml.FireRef(a);if(b instanceof Array)e.params=b;else for(var c=1;c<arguments.length;c++)e.params.push(arguments[c]);return e},bulletml.dsl.changeDirection=function(a,b){for(var c=0,d=arguments.length;d>c;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0===a)throw new Error("direction is required.");if(void 0===b)throw new Error("term is required.");var e=new bulletml.ChangeDirection;return e.direction=a instanceof bulletml.Direction?a:new bulletml.Direction(a),e.term=b,e},bulletml.dsl.changeSpeed=function(a,b){for(var c=0,d=arguments.length;d>c;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0===a)throw new Error("speed is required.");if(void 0===b)throw new Error("term is required.");var e=new bulletml.ChangeSpeed;return e.speed=a instanceof bulletml.Speed?a:new bulletml.Speed(a),e.term=b,e},bulletml.dsl.accel=function(a,b){for(var c=0,d=arguments.length;d>c;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());for(var e=new bulletml.Accel,c=0;c<arguments.length;c++)arguments[c]instanceof bulletml.Horizontal?e.horizontal=a:arguments[c]instanceof bulletml.Vertical?e.vertical=b:e.term=arguments[c];if(void 0===e.horizontal&&void 0===e.vertical)throw new Error("horizontal or vertical is required.");if(void 0===e.term)throw new Error("term is required.");return e},bulletml.dsl.wait=function(a){for(var b=0,c=arguments.length;c>b;b++)arguments[b]instanceof Function&&(arguments[b]=arguments[b]());if(void 0===a)throw new Error("value is required.");return new bulletml.Wait(a)},bulletml.dsl.vanish=function(){return new bulletml.Vanish},bulletml.dsl.repeat=function(a,b){for(var c=0,d=arguments.length;d>c;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0===a)throw new Error("times is required.");if(void 0===b)throw new Error("action is required.");var e=new bulletml.Repeat;if(e.times=a,b instanceof bulletml.Action||b instanceof bulletml.ActionRef)e.action=b;else if(b instanceof Array)e.action=bulletml.dsl.action(b);else{for(var f=[],c=1;c<arguments.length;c++)f.push(arguments[c]);e.action=bulletml.dsl.action(f)}return e},bulletml.dsl.bindVar=function(a,b){return new bulletml.Bind(a,b)},bulletml.dsl.notify=function(a,b){return new bulletml.Notify(a,b)},bulletml.dsl.direction=function(a,b){for(var c=0,d=arguments.length;d>c;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0===a)throw new Error("value is required.");var e=new bulletml.Direction(a);return void 0!==b&&(e.type=b),e},bulletml.dsl.speed=function(a,b){for(var c=0,d=arguments.length;d>c;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0===a)throw new Error("value is required.");var e=new bulletml.Speed(a);return b&&(e.type=b),e},bulletml.dsl.horizontal=function(a,b){for(var c=0,d=arguments.length;d>c;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0===a)throw new Error("value is required.");var e=new bulletml.Horizontal(a);return b&&(e.type=b),e},bulletml.dsl.vertical=function(a,b){for(var c=0,d=arguments.length;d>c;c++)arguments[c]instanceof Function&&(arguments[c]=arguments[c]());if(void 0===a)throw new Error("value is required.");var e=new bulletml.Vertical(a);return b&&(e.type=b),e},bulletml.dsl.fireOption=function(a){return new bulletml.FireOption(a)},bulletml.dsl.offsetX=function(a){return new bulletml.OffsetX(a)},bulletml.dsl.offsetY=function(a){return new bulletml.OffsetY(a)},bulletml.dsl.autonomy=function(a){return new bulletml.Autonomy(a)}}(),function(){bulletml.json=bulletml.json||{}}(),function(){bulletml.runner=bulletml.runner||{},bulletml.runner.RunnerFactory=function(a){this.root=a},bulletml.runner.RunnerFactory.prototype.create=function(a){for(var b in bulletml.runner.DEFAULT_CONFIG)bulletml.runner.DEFAULT_CONFIG.hasOwnProperty(b)&&void 0===a[b]&&(a[b]=bulletml.runner.DEFAULT_CONFIG[b]);var c=this.root.getTopActionLabels();if(1===c.length)return new bulletml.runner.SubRunner(a,this.root.getWalker(c[0]));for(var d=new bulletml.runner.ParentRunner,e=0,f=c.length;f>e;e++)d.addSubRunner(new bulletml.runner.SubRunner(a,this.root.getWalker(c[e])));return d},bulletml.Root.prototype.createRunner=function(a,b){var c=new bulletml.runner.RunnerFactory(this).create(a);return b&&b(c),c},bulletml.runner.DEFAULT_CONFIG={rank:0,target:null,createNewBullet:function(){}},bulletml.runner.Runner=function(){this.x=0,this.y=0},bulletml.runner.Runner.prototype={constructor:bulletml.runner.Runner,update:function(){},onVanish:function(){},onNotify:function(){}},bulletml.runner.ParentRunner=function(){bulletml.runner.Runner.call(this),this.completed=!1,this.completedChildCount=0,this.subRunners=[]},bulletml.runner.ParentRunner.prototype=Object.create(bulletml.runner.Runner.prototype),bulletml.runner.ParentRunner.prototype.addSubRunner=function(a){a.parentRunner=this,this.subRunners.push(a)},bulletml.runner.ParentRunner.prototype.update=function(){for(var a=this.subRunners.length;a--;)this.subRunners[a].x=this.x,this.subRunners[a].y=this.y,this.subRunners[a].update();this.completedChildCount===this.subRunners.length&&(this.completed=!0)},bulletml.runner.SimpleSubRunner=function(a){bulletml.runner.Runner.call(this),this.config=a,this.direction=0,this.speed=0,this.deltaX=null,this.deltaY=null},bulletml.runner.SimpleSubRunner.prototype=Object.create(bulletml.runner.Runner.prototype),bulletml.runner.SimpleSubRunner.prototype.update=function(){null===this.deltaX&&(this.deltaX=Math.cos(this.direction)*this.speed),null===this.deltaY&&(this.deltaY=Math.sin(this.direction)*this.speed),this.x+=this.deltaX,this.y+=this.deltaY},bulletml.runner.SubRunner=function(a,b){bulletml.runner.SimpleSubRunner.call(this,a),this.walker=b,this.waitTo=-1,this.lastDirection=0,this.lastSpeed=0,this.speedH=0,this.speedV=0,this.dirIncr=0,this.dirFin=0,this.chDirEnd=-1,this.spdIncr=0,this.spdFin=0,this.chSpdEnd=-1,this.aclIncrH=0,this.aclFinH=0,this.aclIncrV=0,this.aclFinV=0,this.aclEnd=-1,this.age=-1,this.stop=!1,this.parentRunner=null},bulletml.runner.SubRunner.prototype=Object.create(bulletml.runner.SimpleSubRunner.prototype),bulletml.runner.SubRunner.prototype.update=function(){if(!this.stop){this.age+=1;{this.config}if(this.age<this.chDirEnd?this.direction+=this.dirIncr:this.age===this.chDirEnd&&(this.direction=this.dirFin),this.age<this.chSpdEnd?this.speed+=this.spdIncr:this.age===this.chSpdEnd&&(this.speed=this.spdFin),this.age<this.aclEnd?(this.speedH+=this.aclIncrH,this.speedV+=this.aclIncrV):this.age===this.aclEnd&&(this.speedH=this.aclFinH,this.speedV=this.aclFinV),this.x+=Math.cos(this.direction)*this.speed,this.y+=Math.sin(this.direction)*this.speed,this.x+=this.speedH,this.y+=this.speedV,!(this.age<this.waitTo||this.completed)){for(var a;a=this.walker.next();)switch(a.commandName){case"fire":this.fire(a);break;case"wait":return void(this.waitTo=this.age+a.value);case"changeDirection":this.changeDirection(a);break;case"changeSpeed":this.changeSpeed(a);break;case"accel":this.accel(a);break;case"vanish":this.onVanish();break;case"notify":this.notify(a)}this.completed=!0,null!==this.parentRunner&&(this.parentRunner.completedChildCount+=1)}}},bulletml.runner.SubRunner.prototype.fire=function(a){var c;c=0===a.bullet.actions.length?new bulletml.runner.SimpleSubRunner(this.config):new bulletml.runner.SubRunner(this.config,a.bullet.getWalker());var d={x:this.x+a.option.offsetX,y:this.y+a.option.offsetY},e=a.direction||a.bullet.direction,f=e.value*Math.PI/180;switch(e.type){case"aim":var g=this.config.target;g?(g instanceof Function&&(g=g()),c.direction=a.option.autonomy?b(d,g)+f:b(this,g)+f):c.direction=f-Math.PI/2;break;case"absolute":c.direction=f-Math.PI/2;break;case"relative":c.direction=this.direction+f;break;case"sequence":default:c.direction=this.lastDirection+f}this.lastDirection=c.direction;var h=a.speed||a.bullet.speed,i=h.value;switch(h.type){case"relative":c.speed=this.speed+i;break;case"sequence":c.speed=this.lastSpeed+i;break;case"absolute":default:c.speed=i}this.lastSpeed=c.speed,c.x=d.x,c.y=d.y;var j={};for(var k in a.bullet.option)j[k]=a.bullet.option[k];j.label=a.bullet.label,this.config.createNewBullet(c,j)},bulletml.runner.SubRunner.prototype.changeDirection=function(c){var d=c.direction.value*Math.PI/180,e=c.term;switch(c.direction.type){case"aim":var f=this.config.target;f instanceof Function&&(f=f()),this.dirFin=b(this,f)+d,this.dirIncr=a(this.dirFin-this.direction)/e;break;case"absolute":this.dirFin=d-Math.PI/2,this.dirIncr=a(this.dirFin-this.direction)/e;break;case"relative":this.dirFin=this.direction+d,this.dirIncr=a(this.dirFin-this.direction)/e;break;case"sequence":this.dirIncr=d,this.dirFin=this.direction+this.dirIncr*(e-1)}this.chDirEnd=this.age+e},bulletml.runner.SubRunner.prototype.changeSpeed=function(a){var b=a.speed.value,c=a.term;switch(a.speed.type){case"absolute":this.spdFin=b,this.spdIncr=(this.spdFin-this.speed)/c;break;case"relative":this.spdFin=b+this.speed,this.spdIncr=(this.spdFin-this.speed)/c;break;case"sequence":this.spdIncr=b,this.spdFin=this.speed+this.spdIncr*c}this.chSpdEnd=this.age+c},bulletml.runner.SubRunner.prototype.accel=function(a){var b=a.term;if(this.aclEnd=this.age+b,a.horizontal){var c=a.horizontal.value;switch(a.horizontal.type){case"absolute":case"sequence":this.aclIncrH=(c-this.speedH)/b,this.aclFinH=c;break;case"relative":this.aclIncrH=c,this.aclFinH=(c-this.speedH)*b}}else this.aclIncrH=0,this.aclFinH=this.speedH;if(a.vertical){var d=a.vertical.value;switch(a.vertical.type){case"absolute":case"sequence":this.aclIncrV=(d-this.speedV)/b,this.aclFinV=d;break;case"relative":this.aclIncrV=d,this.aclFinV=(d-this.speedV)*b}}else this.aclIncrV=0,this.aclFinV=this.speedV},bulletml.runner.SubRunner.prototype.notify=function(a){this.onNotify(a.eventName,a.params)};var a=function(a){for(;a<=-Math.PI;)a+=2*Math.PI;for(;Math.PI<a;)a-=2*Math.PI;return a},b=function(a,b){return Math.atan2(b.y-a.y,b.x-a.x)}}(),function(){bulletml.output=bulletml.output||{},bulletml.output.json=bulletml.output.json||{},bulletml.Root.prototype.toJSON=function(){return{className:"Root",actions:this.actions,bullets:this.bullets,fires:this.fires}},bulletml.Bullet.prototype.toJSON=function(){return{className:"Bullet",label:this.label,direction:this.direction,speed:this.speed,actions:this.actions,option:this.options}},bulletml.BulletRef.prototype.toJSON=function(){return{className:"BulletRef",label:this.label,params:this.params}},bulletml.Action.prototype.toJSON=function(){return{className:"Action",label:this.label,commands:this.commands}},bulletml.ActionRef.prototype.toJSON=function(){return{className:"ActionRef",label:this.label,params:this.params}},bulletml.Fire.prototype.toJSON=function(){return{className:"Fire",label:this.label,direction:this.direction,speed:this.speed,bullet:this.bullet,option:this.option}},bulletml.FireRef.prototype.toJSON=function(){return{className:"FireRef",label:this.label,params:this.params}},bulletml.ChangeDirection.prototype.toJSON=function(){return{className:"ChangeDirection",direction:this.direction,term:this.term}},bulletml.ChangeSpeed.prototype.toJSON=function(){return{className:"ChangeSpeed",speed:this.speed,term:this.term}},bulletml.Accel.prototype.toJSON=function(){return{className:"Accel",horizontal:this.horizontal,vertical:this.vertical,term:this.term}},bulletml.Wait.prototype.toJSON=function(){return{className:"Wait",value:this.value}},bulletml.Vanish.prototype.toJSON=function(){return{className:"Vanish"}},bulletml.Repeat.prototype.toJSON=function(){return{className:"Repeat",times:this.times,action:this.action}},bulletml.Bind.prototype.toJSON=function(){return{className:"Bind",variable:this.variable,expression:this.expression}},bulletml.Notify.prototype.toJSON=function(){return{className:"Notify",eventName:this.eventName,params:this.params}},bulletml.Direction.prototype.toJSON=function(){return{className:"Direction",type:this.type,value:this.value}},bulletml.Speed.prototype.toJSON=function(){return{className:"Speed",type:this.type,value:this.value}},bulletml.Horizontal.prototype.toJSON=function(){return{className:"Horizontal",type:this.type,value:this.value}},bulletml.Vertical.prototype.toJSON=function(){return{className:"Vertical",type:this.type,value:this.value}},bulletml.FireOption.prototype.toJSON=function(){return{className:"FireOption",offsetX:this.offsetX,offsetY:this.offsetY,autonomy:this.autonomy}},bulletml.OffsetX.prototype.toJSON=function(){return{className:"OffsetX",value:this.value}},bulletml.OffsetY.prototype.toJSON=function(){return{className:"OffsetY",value:this.value}},bulletml.Autonomy.prototype.toJSON=function(){return{className:"Autonomy",value:this.value}
}}();
//# sourceMappingURL=bulletml.min.js.map